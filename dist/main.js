(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{formatRegistrationData:()=>U});var r={};e.r(r),e.d(r,{formatAirportData:()=>V});const n=require("express");var o=e.n(n);const a=require("http");var s=e.n(a);const i=require("cors");var c=e.n(i);require("dotenv/config");const l={mongoose:{url:`${process.env.MONGO_URL}${process.env.DB_NAME}`},environment:process.env.ENVIRONMENT,port:process.env.PORT,rapidApi:{key:process.env.RAPID_API_KEY,host:process.env.RAPID_API_HOST},newsDataApi:{key:process.env.NEWS_DATA_API_KEY}},u=require("winston");var d=e.n(u);const p=d().format((e=>(e instanceof Error&&Object.assign(e,{message:e.stack}),e))),y=(d().format.combine(d().format.colorize(),d().format.timestamp(),d().format.align(),d().format.printf((e=>`${JSON.stringify(e)}`))),d().createLogger({level:"development"===l.environment?"debug":"info",format:d().format.combine(p(),"development"===l.environment?d().format.colorize():d().format.uncolorize(),d().format.prettyPrint(),d().format.splat(),d().format.json(),d().format.printf((({level:e,message:t})=>`${e}: ${"object"==typeof t?JSON.stringify(t):t}`))),transports:[new(d().transports.Console)({stderrLevels:["error","info"]})]})),m=require("fs");var S=e.n(m);require("cheerio");const g=require("convert-excel-to-json");var f=e.n(g);const A=require("mongoose");var h=e.n(A);const C=new(h().Schema)({searchKeyword:{type:String,require:!0},title:{type:String,unique:!0,maxLength:1024},content:{type:String,maxLength:1024},url:{type:String,maxLength:1024},description:{type:String,maxLength:1024},category:{type:String},language:{type:String},author:{type:String},publishedAt:{type:String},sourceName:{type:String}}),v=h().model("News",C),E=new(h().Schema)({companyCode:{type:String,require:!0,unique:!0},companyName:{type:String,require:!0,unique:!0},price:{type:Number},changePoint:{type:Number},changePercentage:{type:Number},date:{type:String}}),R=h().model("Stocks",E),N=new(h().Schema)({icao:{type:String,require:!0,unique:!0},airportName:{type:String},city:{type:String},country:{type:String},lat_long:{type:String},elevation:{type:String},runwayLength:{type:String},surface:{type:String},fuel:{type:String},fbo:{type:String},lat:{type:String},lng:{type:String}}),L=h().model("Airports",N),O=new(h().Schema)({ntsbNo:{type:String,require:!0,unique:!0},completionStatus:{type:String},eventType:{type:String},city:{type:String},state:{type:String},country:{type:String},reportNo:{type:String},nNumber:{type:String},make:{type:String},model:{type:String},highestInjuryLevel:{type:String},hasSafetyRec:{type:String},mode:{type:String},reportType:{type:String},ReportDate:{type:String}}),w=h().model("Accidents",O),B=new(h().Schema)({regNumber:{type:String,require:!0,unique:!0},serialNumber:{type:String},model:{type:String},mfrYear:{type:String},typeRegistration:{type:String},status:{type:String},certificateIssueDate:{type:String},typeEngine:{type:String},modelSCodebase8:{type:String},modelSCodebase16:{type:String},fractionalOwner:{type:String},registeredOwnerName:{type:String},registeredOwnerStreet:{type:String},registeredOwnerCity:{type:String},registeredOwnerState:{type:String},registeredOwnerZipCode:{type:String},registeredOwnerCountry:{type:String},engineManufacturer:{type:String},engineModel:{type:String},awDate:{type:String}}),D=h().model("Registrations",B),F=(require("path"),{fileUploadPath:"/",columns:{A:"regNumber",C:"serialNumber",E:"faaName",F:"cppName",G:"engineModel",H:"mfrYear",I:"typeRegistration",J:"registeredOwnerName",K:"registeredOwnerStreet",M:"registeredOwnerCity",N:"registeredOwnerState",O:"registeredOwnerZipCode",Q:"registeredOwnerCountry",S:"certificateIssueDate",V:"typeEngine",W:"status",X:"modelSCodebase16",Y:"fractionalOwner",Z:"awDate"}}),k={scheduler:{interval:"0 11 1 * *"},sessionId:480529,mainUrl:"https://data.ntsb.gov/carol-main-public/api/Query/Main",headers:{"content-type":"application/json"},dataKeys:[{key:"NtsbNo",dbKey:"ntsbNo"},{key:"CompletionStatus",dbKey:"completionStatus"},{key:"EventType",dbKey:"eventType"},{key:"City",dbKey:"city"},{key:"State",dbKey:"state"},{key:"Country",dbKey:"country"},{key:"ReportNo",dbKey:"reportNo"},{key:"N#",dbKey:"nNumber"},{key:"VehicleMake",dbKey:"make"},{key:"VehicleModel",dbKey:"model"},{key:"HighestInjuryLevel",dbKey:"highestInjuryLevel"},{key:"HasSafetyRec",dbKey:"hasSafetyRec"},{key:"Mode",dbKey:"mode"},{key:"ReportType",dbKey:"reportType"},{key:"ReportDate",dbKey:"ReportDate"}],models:["FALCON 10","MYSTERE-FALCON 20-C5","MYSTERE FALCON 900","FALCON 50","MYSTERE FALCON 50","CL-600-2C10","BD-100-1A10","BD-700-1A10","BD-700-1A11","BD-100-1A10","CL-600-2B16","CL-600-2A12","CL-600-2B19","CL-600-2B16(CL-604)","CL-600-2D24","BD-700-1A10","BD-700-2A12","CL-600-2C10","CL-600-2B16(CL601-3R","CL-600-2C11","CL600-2B16 (CL601-3A","CL-600-2B16 (CL-605)","CL-600-2E25","CL-215-6B11 (CL-415)","CL-600-2B19","CL-600-2B16","525C","510","560","525A","560XL","525","550","650","525B","501","680","500","750","551","560XLS","525B","525","525C","560XLS+","560XL","680A","680A","SF50","EX18","SF50","FALCON 900 EX","MYSTERE FALCON 50EX","FALCON 2000EX","FALCON 20 F","FALCON 50EX","MYSTERE-FALCON 50","FALCON 2000EX","FALCON 2000","FALCON 900EX","MYSTERE FALCON 900","FALCON 7X","FALCON 900B","FALCON 900","MYSTERE FALCON 20","FALCON 20-F5","MYSTERE-FALCON 20-F5","FALCON 900EX EASY","FALCON 20G","FALCON 900DX","FALCON 50","FALCON 20-D","FALCON 10","MYSTERE FALCON 900","FALCON 50","MYSTERE FALCON 20-F5","FALCON 20","MYSTERE FALCON 20-C5","MYSTERE FALCON 200","MYSTERE FALCON 20-D5","FAN JET FALCON SER F","FAN JET FALCON SER E","FAN JET FALCON","MYSTERE FALCON 20","FAN JET FALCON SER D","MYSTERE FALCON 900B","EA500","EA500","500","EMB-500","EMB-500","EMB-505","EMB-545","EMB-550","EMB-505","EMB-545","EMB-545 LR","EMB-135BJ","EMB-500","EMB-550","EMB-550","ERJ 190 AR","25B","24D","35","28","24E","36A","24F","25","24B","24B-A","24C","24D-A","25C","25F","29","36","25D","55","55B","55C","24","35A","35A (C-21A)","G-IV","GIV-X (G450)","695B","GV-SP (G550)","G-V","G-1159A","840","C-20A","G-IV (G400)","G1159B","GULFSTREAM 200","G-IV (G350)","GV-SP","GIV-X (G350)","GIV-X","G-IV (G300)","GV-SP (G500)","695A","G-III","GVII-G500","GVII-G600","GVII-G500","GVI (G650ER)","GV-SP (G550)","GVII-G600","GVI","GVI (G650)","GVII-G400","GVIII-G800","GVIII-G700","GULFSTREAM 200","G150","G100","GULFSTREAM 100","695A","690D","690C","695","GA-7","G-1159A","G-1159","HAWKER 900XP","HAWKER 900XP","C90GTI","C90GTI","390","390","B200","B200","400A","400A","B200GT","B200GT","G58","G58","4000","4000","B300C","B300C","B300","B300","HAWKER 4000","HAWKER 4000","HAWKER 850XP","HAWKER 850XP","HAWKER 750","HAWKER 750","C90GT","C90GT","HAWKER 800XP","HAWKER 800XP","HS.125 SERIES 700A","DH.125-3A/RA","BH.125-400A","DH.125-400A","HS 125-3A","HS-125 SERIES F-400","HA-420","HA-420","HA-420","GULFSTREAM G280","GULFSTREAM G150","GULFSTREAM G280","GULFSTREAM 200","1125 WESTWIND ASTRA","35A","60","45","31A","35A","24D","60 XR","23","24B","55","24","24A","31","25D","25","35","C-21A","MU-2B","MU-2B-25","MU-2B-60","MU-2B-40","MU-2B-20","MU-2B-36A","MU-300","MU-2B-26","MU-2B-36","TYPE ZERO","MU-2B-26A","MU-2B-35","PC-24"]},M={scheduler:{interval:"0 15 * * *"},stonkApiUrl:"https://realstonks.p.rapidapi.com/",stonkApiHeaders:{"X-RapidAPI-Key":`${l.rapidApi.key}`,"X-RapidAPI-Host":"realstonks.p.rapidapi.com"},companies:[{key:"GD",name:"General Dynamic"},{key:"TXT",name:"Textron"},{key:"BDRAF",name:"Bombardier"},{key:"ERF",name:"Embraer"},{key:"DUAVF",name:"Dassault Aviation"},{key:"UP",name:"Wheels Up"},{key:"EADSF",name:"Airbus"},{key:"BA",name:"Boeing"},{key:"BP",name:"BP PLC"},{key:"NTOIF",name:"Neste OYJ"},{key:"SHEL",name:"Shell PLC"},{key:"HON",name:"Honeywell "},{key:"GE",name:"General Electric"},{key:"RYCEF",name:"Rolls-Royce"},{key:"WMB",name:"Williams International"},{key:"COL",name:"Rockwell Collins"}]},b={scheduler:{interval:"0 10,14,18 * * *"},newsDataUrl:"https://newsomaticapi.p.rapidapi.com/top",requestHeaders:{"X-RapidAPI-Key":`${l.rapidApi.key}`,"X-RapidAPI-Host":"newsomaticapi.p.rapidapi.com"},requestLanguage:"en",keywords:["private jet","business jet","private aviation","bombardier","dassault falcon","gulfstream","learjet","cessna citation","embraer legacy","embraer praetor","embraer phenom","embraer lineage","hondajet","nextant","pilatus pc-24","textron","economy","finance","market","inflation"]},G={columns:{A:"icao",B:"airportName",C:"city",D:"country",E:"lat_long",F:"elevation",G:"runwayLength",H:"surface",I:"fuel",J:"fbo",K:"latitude",L:"longitude"},fileUploadPath:"/"},T=require("moment");var I=e.n(T);const P=require("node-fetch");var q=e.n(P);const U=e=>{if(!e.regNumber)return;const t=Object.keys(e);let r={};return t.forEach((t=>{r[t]=`${e[t]}`||""})),r},K=async(e,t,r)=>({ResultSetSize:100,ResultSetOffset:0,QueryGroups:[{QueryRules:[{RuleType:"Simple",Values:[`${t}`],Columns:["Event.EventDate"],Operator:"is on or after",overrideColumn:"",selectedOption:{FieldName:"EventDate",DisplayText:"Event date",Columns:["Event.EventDate"],Selectable:!0,InputType:"Date",RuleType:0,Options:null,TargetCollection:"cases",UnderDevelopment:!0}},{RuleType:"Simple",Values:[`${r}`],Columns:["Event.EventDate"],Operator:"is on or before",selectedOption:{FieldName:"EventDate",DisplayText:"Event date",Columns:["Event.EventDate"],Selectable:!0,InputType:"Date",RuleType:0,Options:null,TargetCollection:"cases",UnderDevelopment:!0},overrideColumn:""},{RuleType:"Simple",Values:["Aviation"],Columns:["Event.Mode"],Operator:"is",selectedOption:{FieldName:"Mode",DisplayText:"Investigation mode",Columns:["Event.Mode"],Selectable:!0,InputType:"Dropdown",RuleType:0,Options:null,TargetCollection:"cases",UnderDevelopment:!0},overrideColumn:""}],AndOr:"and",inLastSearch:!1,editedSinceLastSearch:!1}],AndOr:"and",SortColumn:null,SortDescending:!0,TargetCollection:"cases",SessionId:e}),H=(e,t)=>{if(e)return{companyCode:t.key,companyName:t.name,date:e.date=I()().format("L").toString(),price:e.price,changePoint:e.change_point,changePercentage:e.change_percentage}},Y=(e,t)=>{if(!e.articles)return;const r=e.articles.map((e=>((e,t)=>(e.sourceName=e.source.name||"",e.searchKeyword=t,delete e.urlToImage,delete e.source,e))(e,t)));return r},V=e=>{if(!e.icao)return;const t=Object.keys(e);let r={};return t.forEach((t=>{r[t]=`${e[t]}`||""})),r},X=async(e,t)=>{const r=await q()(e,t);return await r.json()},j=async e=>{try{y.info({event:"Service: New news",data:e});const t=await v.insertMany(e,{ordered:!1});return y.info({event:"Service: Records added in Mongo DB",news:t}),t}catch(e){11e3===e.code&&y.info("Service: Record already exists."),y.error(e)}},x=o().Router();x.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;y.info({event:"Service: New Request Accidents from DB",data:{numberOfRecords:r,currentPage:n}});const o=await w.find().skip(r*n).limit(r);return y.info({event:"Service: Accidents from DB",accidents:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){y.error(e)}})(r,n);y.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const $=x,W=require("multer");var _=e.n(W);const J=(e,t,r)=>{(e=>e.mimetype.includes("excel")||e.mimetype.includes("spreadsheetml"))(t)?r(null,!0):r("Please upload valid Excel Sheet.",!1)},z=_().diskStorage({destination:(e,t,r)=>{r(null,G.fileUploadPath)},filename:(e,t,r)=>{r(null,t.originalname)}}),Q=_().diskStorage({destination:(e,t,r)=>{r(null,F.fileUploadPath)},filename:(e,t,r)=>{r(null,t.originalname)}}),Z=_()({storage:z,fileFilter:J}),ee=_()({storage:Q,fileFilter:J}),te=o().Router();te.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;y.info({event:"Service: New Request Registrations from DB",data:{numberOfRecords:r,currentPage:n}});const o=await D.find().skip(r*n).limit(r);return y.info({event:"Service: Registrations from DB",registrations:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){y.error(e)}})(r,n);y.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)})),te.route("/create").post(ee.single("file"),(async(e,r)=>{if(e.file){e.file.filename;const n=await(async()=>{try{const{columns:e}=F,{formatRegistrationData:r}=t,n=S().readdirSync(F.fileUploadPath).map((e=>{const t=e.split(".");if("xlsx"===t[t.length-1])return e})).filter((e=>!!e));if(n.length>1||0===n.length)return{sccess:!1,statusCode:422,error:"There is no file or multiple files. Please keep just 1 *.xslx file."};const o=f()({sourceFile:`${F.fileUploadPath}/${n[0]}`,columnToKey:e});if(o.Sheet1){const e=o.Sheet1;e.shift();const t=[],a=[];for(let n in e){const o=r(e[n]);o?t.push(o):a.push(e[n])}const s=await D.insertMany(e,{ordered:!1}),i={success:!0,statusCode:200,totalRecords:e.length,success:s.length,failed:a.length,failedRecords:a};return S().unlink(`${F.fileUploadPath}/${n[0]}`,(e=>{y.info("File removed!")})),y.info({event:"Service: Records added in MongoDB",data:i}),i}}catch(e){y.error(e)}})();y.info({event:"Controller: Creating new records",result:n}),r.status(n.statusCode).json(n)}}));const re=te,ne=o().Router();ne.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;y.info({event:"Service: New Request Stocks from DB",data:{numberOfRecords:r,currentPage:n}});const o=await R.find().skip(r*n).limit(r);return y.info({event:"Service: Stocks from DB",stocks:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){y.error(e)}})(r,n);y.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const oe=ne,ae=o().Router();ae.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;y.info({event:"Service: New Request airports from DB",data:{numberOfRecords:r,currentPage:n}});const o=await L.find().skip(r*n).limit(r);return y.info({event:"Service: Airports from DB",airports:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){y.error(e)}})(r,n);y.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)})),ae.route("/create").post(Z.single("file"),(async(e,t)=>{if(e.file){e.file.filename;const n=await(async e=>{try{const{columns:e}=G,{formatAirportData:t}=r,n=S().readdirSync(G.fileUploadPath).map((e=>{const t=e.split(".");if("xlsx"===t[t.length-1])return e})).filter((e=>!!e));if(n.length>1||0===n.length)return{sccess:!1,statusCode:422,error:"There is no file or multiple files. Please keep just 1 *.xslx file."};const o=f()({sourceFile:`${G.fileUploadPath}/${n[0]}`,columnToKey:e});if(o.Sheet1){const e=o.Sheet1;e.shift();const r=[],a=[];for(let n in e){const o=t(e[n]);o?r.push(o):a.push(e[n])}const s=await L.insertMany(r,{ordered:!1}),i={success:!0,statusCode:200,totalRecords:e.length,success:s.length,failed:a.length,failedRecords:a};return S().unlink(`${G.fileUploadPath}/${n[0]}`,(e=>{y.info("File removed!")})),y.info({event:"Service: Records added in MongoDB",data:i}),i}}catch(e){y.error(e)}})();y.info({event:"Controller: Creating new records",result:n}),t.status(n.statusCode).json(n)}}));const se=ae,ie=o().Router();ie.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;y.info({event:"Service: New Request News from DB",data:{numberOfRecords:r,currentPage:n}});const o=await v.find().skip(r*n).limit(r);return y.info({event:"Service: News from DB",news:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){y.error(e)}})(r,n);y.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const ce=ie,le=o().Router();le.use("/accidents",$),le.use("/registrations",re),le.use("/stocks",oe),le.use("/news",ce),le.use("/airports",se);const ue=le;h().connect(l.mongoose.url).then((()=>{console.log("MongoDB URL => ",l.mongoose.url),y.info("Connected to MongoDB")})).catch((e=>{y.error(e)}));const de=require("node-cron");var pe=e.n(de);const ye=b.scheduler.interval;pe().schedule(ye,(async()=>{y.info("News: Scheduler Started");const e=await(async()=>{try{y.info({event:"Service: Request for News "});const{newsDataUrl:e,keywords:t,requestHeaders:r,requestLanguage:n}=b,o={headers:r},a=t.map((t=>`${e}?q='${t}'&language=${n}`)),s=[];for(let e in a){const r=await X(a[e],o),n=Y(r,t[e]);n&&s.push(n)}return y.info({event:"Service: All News",news:s}),s}catch(e){y.error(e)}})()||[];if(y.info({event:"Scheduler: Fetch News",news:e}),e.length>0){for(let t in e)if(e[t].length>0){const r=await j(e[t]);y.info(r)}}else y.info({event:"Scheduler: No news found. :-)"})}));const me=k.scheduler.interval;pe().schedule(me,(async()=>{y.info("Accidents: Scheduler Started");const{sessionId:e}=k,t=I()().subtract(1,"months").startOf("month").format("YYYY-MM-DD").toString(),r=I()().subtract(1,"months").endOf("month").format("YYYY-MM-DD").toString(),n=await(async(e,t,r)=>{try{y.info({event:"Service: Request for Accidents ",data:{sessionId:e,startingDate:t,endingDate:r}});const{mainUrl:n,headers:o}=k,a={headers:o,method:"POST",body:JSON.stringify(await K(e,t,r))},s=(e=>{const{models:t}=k;return e.Results.map((e=>(e=>{const{dataKeys:t}=k,r={};return t.forEach((t=>{r[t.dbKey]=e.find((e=>e.FieldName===t.key)).Values[0]||""})),r})(e.Fields))).filter((e=>t.includes(e.model)))})(await X(n,a));return y.info({event:"Service: All Accidents",accidents:s}),s}catch(e){y.error(e)}})(e,t,r)||[];if(y.info({event:"Scheduler: Fetch accidents after all Filters",accidents:n}),n.length>0){const e=await(async e=>{try{y.info({event:"Service: New Accident",data:e});const t=await w.insertMany(e,{ordered:!1});return y.info({event:"Service: Record added in Mongo DB",accident:t}),t}catch(e){11e3===e.code&&y.info("Service: Record already exists."),y.error(e)}})(n)||[];y.info(e)}else y.info({event:"Scheduler: No new accidents found. :-)"})}));const Se=M.scheduler.interval;pe().schedule(Se,(async()=>{y.info("Company Stocks: Scheduler Started");const e=await(async()=>{try{y.info({event:"Service: Request for Company Stocks "});let{stonkApiUrl:e,stonkApiHeaders:t,companies:r}=M;const n={headers:t},o=[],a=r.map((t=>e+t.key));for(let e in a){const t=await X(a[e],n),s=H(t,r[e]);o.push(s)}return y.info({event:`Service: All company stocks for ${I()().format("L").toString()}`,companyStocks:o}),o}catch(e){y.error(e)}})()||[];if(y.info({event:"Scheduler: Fetch company stocks",companyStocks:e}),e.length>0){const t=await(async e=>{try{y.info({event:"Service: New Accident",data:e});const t=await R.insertMany(e);return y.info({event:"Service: Records added in Mongo DB",companyStocks:t}),t}catch(e){11e3===e.code&&y.info("Service: Record already exists."),y.error(e)}})(e);y.info(t)}else y.info({event:"Scheduler: No company stocks found. :-)"})}));const ge=o()();ge.use(c()()),setInterval((()=>{s().get("http://healthcheck-backend-888c77da0ba5.herokuapp.com/"),console.log("App is alive!")}),12e5),ge.use("/aircraft",ue),ge.get("/",((e,t)=>{t.send("Welcome to Healthcheck App!")}));const fe=l.port;ge.listen(fe,(()=>{y.info(`App is running on port ${fe}`)}))})();