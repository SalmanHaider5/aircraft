(()=>{"use strict";var e={n:t=>{var r=t&&t.__esModule?()=>t.default:()=>t;return e.d(r,{a:r}),r},d:(t,r)=>{for(var n in r)e.o(r,n)&&!e.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:r[n]})},o:(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r:e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})}},t={};e.r(t),e.d(t,{formatAirportData:()=>D});const r=require("express");var n=e.n(r);const o=require("http");var a=e.n(o);const i=require("cors");var s=e.n(i);require("dotenv/config");const c={mongoose:{url:`${process.env.MONGO_URL}${process.env.DB_NAME}`},environment:process.env.ENVIRONMENT,port:process.env.PORT,rapidApi:{key:process.env.RAPID_API_KEY,host:process.env.RAPID_API_HOST},newsDataApi:{key:process.env.NEWS_DATA_API_KEY}},u=require("winston");var l=e.n(u);const d=l().format((e=>(e instanceof Error&&Object.assign(e,{message:e.stack}),e))),g=(l().format.combine(l().format.colorize(),l().format.timestamp(),l().format.align(),l().format.printf((e=>`${JSON.stringify(e)}`))),l().createLogger({level:"development"===c.environment?"debug":"info",format:l().format.combine(d(),"development"===c.environment?l().format.colorize():l().format.uncolorize(),l().format.prettyPrint(),l().format.splat(),l().format.json(),l().format.printf((({level:e,message:t})=>`${e}: ${"object"==typeof t?JSON.stringify(t):t}`))),transports:[new(l().transports.Console)({stderrLevels:["error","info"]})]})),S=require("cheerio"),f=require("mongoose");var p=e.n(f);const y=new(p().Schema)({searchKeyword:{type:String,require:!0},title:{type:String,unique:!0,maxLength:1024},content:{type:String,maxLength:1024},url:{type:String,maxLength:1024},description:{type:String,maxLength:1024},category:{type:String},language:{type:String},author:{type:String},publishedAt:{type:String},sourceName:{type:String}}),m=p().model("News",y),A=new(p().Schema)({companyCode:{type:String,require:!0,unique:!0},companyName:{type:String,require:!0,unique:!0},price:{type:Number},changePoint:{type:Number},changePercentage:{type:Number},date:{type:String}}),C=p().model("Stocks",A),R=new(p().Schema)({icao:{type:String,require:!0,unique:!0},airportName:{type:String},city:{type:String},country:{type:String},lat_long:{type:String},elevation:{type:String},runwayLength:{type:String},surface:{type:String},fuel:{type:String},fbo:{type:String},lat:{type:String},lng:{type:String}}),E=p().model("Airports",R),h=new(p().Schema)({ntsbNo:{type:String,require:!0,unique:!0},completionStatus:{type:String},eventType:{type:String},city:{type:String},state:{type:String},country:{type:String},reportNo:{type:String},nNumber:{type:String},make:{type:String},model:{type:String},highestInjuryLevel:{type:String},hasSafetyRec:{type:String},mode:{type:String},reportType:{type:String},ReportDate:{type:String}}),N=p().model("Accidents",h),v=new(p().Schema)({regNumber:{type:String,require:!0,unique:!0},serialNumber:{type:String},model:{type:String},mfrYear:{type:String},typeRegistration:{type:String},status:{type:String},certificateIssueDate:{type:String},typeEngine:{type:String},modelSCodebase8:{type:String},modelSCodebase16:{type:String},fractionalOwner:{type:String},registeredOwnerName:{type:String},registeredOwnerStreet:{type:String},registeredOwnerCity:{type:String},registeredOwnerState:{type:String},registeredOwnerZipCode:{type:String},registeredOwnerCountry:{type:String},engineManufacturer:{type:String},engineModel:{type:String},awDate:{type:String}}),L=p().model("Registrations",v),B={scheduler:{interval:"*/10 * * * *"},home_url:"https://registry.faa.gov/aircraftinquiry/Search/RecentRegistrationResult",registration_url:"https://registry.faa.gov/aircraftinquiry/Search/NNumberResult?NNumberTxt=",url_headers:{"User-Agent":"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/119.0.0.0 Safari/537.36"},models:["FALCON 10","MYSTERE-FALCON 20-C5","MYSTERE FALCON 900","FALCON 50","MYSTERE FALCON 50","CL-600-2C10","BD-100-1A10","BD-700-1A10","BD-700-1A11","BD-100-1A10","CL-600-2B16","CL-600-2A12","CL-600-2B19","CL-600-2B16(CL-604)","CL-600-2D24","BD-700-1A10","BD-700-2A12","CL-600-2C10","CL-600-2B16(CL601-3R","CL-600-2C11","CL600-2B16 (CL601-3A","CL-600-2B16 (CL-605)","CL-600-2E25","CL-215-6B11 (CL-415)","CL-600-2B19","CL-600-2B16","525C","510","560","525A","560XL","525","550","650","525B","501","680","500","750","551","560XLS","525B","525","525C","560XLS+","560XL","680A","680A","SF50","EX18","SF50","FALCON 900 EX","MYSTERE FALCON 50EX","FALCON 2000EX","FALCON 20 F","FALCON 50EX","MYSTERE-FALCON 50","FALCON 2000EX","FALCON 2000","FALCON 900EX","MYSTERE FALCON 900","FALCON 7X","FALCON 900B","FALCON 900","MYSTERE FALCON 20","FALCON 20-F5","MYSTERE-FALCON 20-F5","FALCON 900EX EASY","FALCON 20G","FALCON 900DX","FALCON 50","FALCON 20-D","FALCON 10","MYSTERE FALCON 900","FALCON 50","MYSTERE FALCON 20-F5","FALCON 20","MYSTERE FALCON 20-C5","MYSTERE FALCON 200","MYSTERE FALCON 20-D5","FAN JET FALCON SER F","FAN JET FALCON SER E","FAN JET FALCON","MYSTERE FALCON 20","FAN JET FALCON SER D","MYSTERE FALCON 900B","EA500","EA500","500","EMB-500","EMB-500","EMB-505","EMB-545","EMB-550","EMB-505","EMB-545","EMB-545 LR","EMB-135BJ","EMB-500","EMB-550","EMB-550","ERJ 190 AR","25B","24D","35","28","24E","36A","24F","25","24B","24B-A","24C","24D-A","25C","25F","29","36","25D","55","55B","55C","24","35A","35A (C-21A)","G-IV","GIV-X (G450)","695B","GV-SP (G550)","G-V","G-1159A","840","C-20A","G-IV (G400)","G1159B","GULFSTREAM 200","G-IV (G350)","GV-SP","GIV-X (G350)","GIV-X","G-IV (G300)","GV-SP (G500)","695A","G-III","GVII-G500","GVII-G600","GVII-G500","GVI (G650ER)","GV-SP (G550)","GVII-G600","GVI","GVI (G650)","GVII-G400","GVIII-G800","GVIII-G700","GULFSTREAM 200","G150","G100","GULFSTREAM 100","695A","690D","690C","695","GA-7","G-1159A","G-1159","HAWKER 900XP","HAWKER 900XP","C90GTI","C90GTI","390","390","B200","B200","400A","400A","B200GT","B200GT","G58","G58","4000","4000","B300C","B300C","B300","B300","HAWKER 4000","HAWKER 4000","HAWKER 850XP","HAWKER 850XP","HAWKER 750","HAWKER 750","C90GT","C90GT","HAWKER 800XP","HAWKER 800XP","HS.125 SERIES 700A","DH.125-3A/RA","BH.125-400A","DH.125-400A","HS 125-3A","HS-125 SERIES F-400","HA-420","HA-420","HA-420","GULFSTREAM G280","GULFSTREAM G150","GULFSTREAM G280","GULFSTREAM 200","1125 WESTWIND ASTRA","35A","60","45","31A","35A","24D","60 XR","23","24B","55","24","24A","31","25D","25","35","C-21A","MU-2B","MU-2B-25","MU-2B-60","MU-2B-40","MU-2B-20","MU-2B-36A","MU-300","MU-2B-26","MU-2B-36","TYPE ZERO","MU-2B-26A","MU-2B-35","PC-24"]},O=(c.rapidApi.key,c.rapidApi.key,{columns:{A:"icao",B:"airportName",C:"city",D:"country",E:"lat_long",F:"elevation",G:"runwayLength",H:"surface",I:"fuel",J:"fbo",K:"latitude",L:"longitude"}}),w=require("moment");var b=e.n(w);const M=require("node-fetch");var F=e.n(M);const G=async e=>b()(e,"L").subtract(1,"days").format("L").toString(),D=e=>{if(!e.icao)return;const t=Object.keys(e);let r={};return t.forEach((t=>{r[t]=`${e[t]}`||""})),r},I=async(e,t)=>{const r=await F()(e,t);return await r.text()},T=async e=>{try{g.info({event:"Service: Request for Registrations for Specific Page",pageNumber:e});const{home_url:t,url_headers:r}=B,n={headers:r},o=`${t}?Sort_Option=5&Page=${e}`;g.info({event:"Service: Request for Registrations for Specific Page",data:{url:o,pageNumber:e,options:n}});const a=await I(o,n),i=await(async e=>{const{models:t}=B;let r=[];const n=S.load(e);return n(".devkit-table-row").each(((e,t)=>{if(0!==e){const e=n(t).find("td"),o={nNumber:n(e[0]).text().trim(),model:n(e[3]).text().trim(),certIssueDate:n(e[4]).text().trim()};r.push(o)}})),r})(a);return g.info({event:"Service: All Registrations for Specific Page",registrations:i}),i}catch(e){g.error(e)}},q=require("fs");var P=e.n(q);const x=require("convert-excel-to-json");var k=e.n(x);const _=n().Router();_.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;g.info({event:"Service: New Request Accidents from DB",data:{numberOfRecords:r,currentPage:n}});const o=await N.find().skip(r*n).limit(r);return g.info({event:"Service: Accidents from DB",accidents:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){g.error(e)}})(r,n);g.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const X=_,H=n().Router();H.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;g.info({event:"Service: New Request Registrations from DB",data:{numberOfRecords:r,currentPage:n}});const o=await L.find().skip(r*n).limit(r);return g.info({event:"Service: Registrations from DB",registrations:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){g.error(e)}})(r,n);g.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const V=H,Y=n().Router();Y.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;g.info({event:"Service: New Request Stocks from DB",data:{numberOfRecords:r,currentPage:n}});const o=await C.find().skip(r*n).limit(r);return g.info({event:"Service: Stocks from DB",stocks:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){g.error(e)}})(r,n);g.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const U=Y,j=n().Router();j.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;g.info({event:"Service: New Request airports from DB",data:{numberOfRecords:r,currentPage:n}});const o=await E.find().skip(r*n).limit(r);return g.info({event:"Service: Airports from DB",airports:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){g.error(e)}})(r,n);g.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)})),j.route("/create").post((async(e,r)=>{const n=await(async()=>{try{const{columns:e}=O,{formatAirportData:r}=t,n=P().readdirSync("./").map((e=>{const t=e.split(".");if("xlsx"===t[t.length-1])return e})).filter((e=>!!e));if(n.length>1||0===n.length)return{sccess:!1,statusCode:422,error:"There is no file or multiple files. Please keep just 1 *.xslx file."};const o=k()({sourceFile:`./${n[0]}`,columnToKey:e});if(o.Sheet1){const e=o.Sheet1;e.shift();const t=[],n=[];for(let o in e){const a=r(e[o]);a?t.push(a):n.push(e[o])}const a=await E.insertMany(t,{ordered:!1}),i={success:!0,statusCode:200,totalRecords:e.length,success:a.length,failed:n.length,failedRecords:n};return g.info({event:"Service: Records added in MongoDB",data:i}),i}}catch(e){g.error(e)}})();g.info({event:"Controller: Creating new records",result:n}),r.status(n.statusCode).json(n)}));const K=j,W=n().Router();W.route("/").get((async(e,t)=>{const r=e.query.records,n=e.query.page,o=await(async(e,t)=>{try{const r=e||10,n=t-1||0;g.info({event:"Service: New Request News from DB",data:{numberOfRecords:r,currentPage:n}});const o=await m.find().skip(r*n).limit(r);return g.info({event:"Service: News from DB",news:o}),{status:"Success",statusCode:200,count:o.length,data:o}}catch(e){g.error(e)}})(r,n);g.info({event:"Controller: Records from DB",result:o}),t.status(o.statusCode).json(o)}));const $=W,J=n().Router();J.use("/accidents",X),J.use("/registrations",V),J.use("/stocks",U),J.use("/news",$),J.use("/airports",K);const z=J;p().connect(c.mongoose.url).then((()=>{console.log("MongoDB URL => ",c.mongoose.url),g.info("Connected to MongoDB")})).catch((e=>{g.error(e)})),require("node-cron"),B.scheduler.interval;const Z=async()=>{let e=[],t=!1,r=await(async()=>{try{const{home_url:e,url_headers:t}=B,r={headers:t};console.log("Invoked"),g.info({event:"Service: Request for Pagination to Check Page",data:{url:e,options:r}});const n=await I(e,r),o=S.load(n)(".pagination2center p").text().trim(),a=await(async e=>{const t=e.split(" ");return parseInt(t[t.length-1].split(")")[0])})(o);return console.log("Page Number =>",a),g.info({event:"Service: Last Page Number",pageNumber:a}),a}catch(e){g.error(e)}})();g.info({event:"Scheduler: Fetch Last Page",lastPage:r});let n=r,o="";for(;!t;){const a=await T(n);if(n===r){const e=a[a.length-1].certIssueDate;o=await G(e)}n-=1,t=!!a.find((e=>e.certIssueDate===o)),e=[...e,...a]}g.info({event:"Scheduler: Fetch All Registrations",allRegistrations:e});const a=await(async(e,t)=>e.filter((e=>e.certIssueDate!==t)))(e,o);g.info({event:"Scheduler: Filtered Registrations with Date",latestRegistrations:a});const i=await(async e=>{const{models:t}=B;let r=[];return e.forEach((e=>{t.includes(e.model)&&r.push(e.nNumber)})),r})(a);return g.info({event:"Scheduler: Filtered Registrations with Models",filteredRegistrations:i}),i};(async()=>{g.info("Registrations: Scheduler Started");const e=await Z()||[];console.log("Registrations =>",e),g.info({event:"Scheduler: Fetch Registrations after all Filters",registrations:e}),e.length>0?e.forEach((async e=>{const t=await(async e=>{try{const{registration_url:t,url_headers:r}=B,n={headers:r},o=t+e;g.info({event:"Service: Request for Registration Detail for N-Number",data:{url:o,nNumber:e,options:n}});const a=await I(o,n),i=await(async(e,t)=>{const r=S.load(t);return{regNumber:e,serialNumber:r('td[data-label="Serial Number"]').first().text().trim()||"",model:r('td[data-label="Model"]').first().text().trim()||"",mfrYear:r('td[data-label="Mfr Year"]').first().text().trim()||"",typeRegistration:r('td[data-label="Type Registration"]').first().text().trim()||"",status:r('td[data-label="Status"]').first().text().trim()||"",certificateIssueDate:r('td[data-label="Certificate Issue Date"]').first().text().trim()||"",typeEngine:r('td[data-label="Engine Type"]').first().text().trim()||"",modelSCodebase8:r('td[data-label="Mode S Code (Base 8 / oct)"]').first().text().trim()||"",modelSCodebase16:r('td[data-label="Mode S Code (Base 16 / Hex)"]').first().text().trim()||"",fractionalOwner:r('td[data-label="Fractional Owner"]').first().text().trim()||"",registeredOwnerName:r('td[data-label="Name"][colspan="3"]').first().text().trim()||"",registeredOwnerStreet:r('td[data-label="Street"]').first().text().trim()||"",registeredOwnerCity:r('td[data-label="City"]').first().text().trim()||"",registeredOwnerState:r('td[data-label="State"]').first().text().trim()||"",registeredOwnerZipCode:r('td[data-label="Zip Code"]').first().text().trim()||"",registeredOwnerCountry:r('td[data-label="Country"]').first().text().trim()||"",engineManufacturer:r('td[data-label="Engine Manufacturer"]').first().text().trim()||"",engineModel:r('td[data-label="Engine Model"]').first().text().trim()||"",awDate:r('td[data-label="A/W Date"]').first().text().trim()||""}})(e,a);return g.info({event:"Service: Registration Detail for N-Number",record:i}),i}catch(e){g.error(e)}})(e),r=await(async e=>{try{g.info({event:"Service: New Registration",data:e});const t=await L.create(e);return g.info({event:"Service: Record added in Mongo DB",registration:t}),t}catch(e){11e3===e.code&&g.info("Service: Record already exists."),g.error(e)}})(t);g.info(r)})):g.info({event:"Scheduler: No new registrations found. :-)"})})();const Q=n()();Q.use(s()()),setInterval((()=>{a().get("http://healthcheck-backend-888c77da0ba5.herokuapp.com/"),console.log("App is alive!")}),12e5),Q.use("/aircraft",z),Q.get("/",((e,t)=>{t.send("Welcome to Healthcheck App!")}));const ee=c.port;Q.listen(ee,(()=>{g.info(`App is running on port ${ee}`)}))})();